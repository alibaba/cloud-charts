# CloudCharts 重构实施指南

## 快速开始

### 0. 前置准备

```bash
# 1. 检查当前环境
node -v  # 需要 >= 18
npm -v   # 需要 >= 9

# 2. 备份当前代码
git tag backup-before-refactor
git push origin backup-before-refactor

# 3. 创建重构分支
git checkout -b refactor/modernization
```

### 1. 立即执行的任务

#### 任务 1.1: 安装现代构建工具

```bash
# 在项目根目录执行
npm install -D \
  vite \
  @vitejs/plugin-react \
  vitest \
  @testing-library/react \
  @testing-library/jest-dom \
  jsdom \
  typedoc
```

#### 任务 1.2: 创建 Vite 配置

创建 `vite.config.ts`:

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { resolve } from 'path';
import { readFileSync } from 'fs';

// 读取 package.json 获取版本号
const packageJson = JSON.parse(readFileSync('./package.json', 'utf-8'));

export default defineConfig({
  plugins: [react()],
  
  // 构建配置
  build: {
    lib: {
      entry: resolve(__dirname, 'src/index.ts'),
      name: 'CloudCharts',
      fileName: (format) => `index.${format}.js`,
      formats: ['es', 'cjs', 'umd']
    },
    rollupOptions: {
      external: [
        'react',
        'react-dom',
        '@antv/g2',
        '@antv/data-set',
        'lodash',
        'classnames'
      ],
      output: {
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM',
          '@antv/g2': 'G2',
          '@antv/data-set': 'DataSet',
          lodash: '_',
          classnames: 'classNames'
        },
        // 保留目录结构
        preserveModules: false
      }
    },
    // 环境变量注入
    define: {
      __VERSION__: JSON.stringify(packageJson.version),
      'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV || 'production')
    }
  },
  
  // TypeScript 配置
  resolve: {
    alias: {
      '@alicloud/cloud-charts': resolve(__dirname, 'src')
    }
  },
  
  // CSS 预处理
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `@import "./src/themes/variables.scss";`
      }
    }
  },
  
  // 测试配置
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./test/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'test/',
        '**/*.d.ts',
        '**/*.stories.{js,jsx,ts,tsx}'
      ]
    }
  }
});
```

#### 任务 1.3: 迁移构建脚本逻辑

创建 `scripts/build-themes.ts` (替代 build.before.js):

```typescript
import { readFileSync, writeFileSync, readdirSync } from 'fs';
import { resolve } from 'path';
import { compileString } from 'sass';

// 从 SCSS 编译主题变量到 JS
function compileTheme(themePath: string, outputPath: string) {
  const scss = readFileSync(themePath, 'utf-8');
  const result = compileString(scss, {
    loadPaths: [resolve(__dirname, '../src/themes')]
  });
  
  // 简化的变量提取（实际需要更复杂的解析）
  const vars = extractVariables(result.css);
  
  writeFileSync(outputPath, `export default ${JSON.stringify(vars)};`);
}

function extractVariables(css: string): Record<string, string> {
  // 实现变量提取逻辑
  const vars: Record<string, string> = {};
  // ... 提取逻辑
  return vars;
}

// 主函数
function main() {
  const themePath = resolve(__dirname, '../src/themes');
  const themes = readdirSync(themePath).filter(f => f.endsWith('.scss'));
  
  themes.forEach(theme => {
    if (theme === 'base.scss' || theme === 'index.scss') return;
    
    const input = resolve(themePath, theme);
    const output = resolve(themePath, theme.replace('.scss', '.style.ts'));
    
    compileTheme(input, output);
    console.log(`✅ 编译主题: ${theme}`);
  });
}

main();
```

#### 任务 1.4: 更新 package.json

```json
{
  "name": "@alicloud/cloud-charts",
  "version": "2.0.0-beta.1",
  "type": "module",
  "main": "./dist/index.cjs.js",
  "module": "./dist/index.es.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.es.js",
      "require": "./dist/index.cjs.js",
      "types": "./dist/index.d.ts"
    }
  },
  "scripts": {
    "dev": "vite",
    "build": "npm run build:themes && vite build && npm run build:types",
    "build:themes": "tsx scripts/build-themes.ts",
    "build:types": "tsc --emitDeclarationOnly --outDir dist",
    "preview": "vite preview",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "storybook": "storybook dev -p 6006",
    "build-storybook": "storybook build",
    "docs": "typedoc --out docs src/index.ts"
  },
  "peerDependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "@antv/g2": "^5.0.0",
    "vite": "^5.0.0",
    "typescript": "^5.3.0",
    "vitest": "^1.0.0",
    "storybook": "^7.6.0"
  }
}
```

### 2. 验证构建系统

```bash
# 1. 清理旧构建
rm -rf lib es build node_modules/.vite

# 2. 安装依赖
npm install

# 3. 测试构建
npm run build

# 4. 检查产物
ls -la dist/
# 应该看到:
# - index.es.js
# - index.cjs.js
# - index.umd.js
# - index.d.ts

# 5. 运行测试
npm test

# 6. 启动 Storybook 验证
npm run storybook
```

### 3. 常见问题解决

#### 问题 1: SCSS 编译失败

**错误**: `Cannot find module 'sass'`

**解决**:
```bash
npm install -D sass
```

#### 问题 2: TypeScript 类型错误

**错误**: `Cannot find module '@antv/g2'`

**解决**:
```bash
npm install -D @antv/g2@^5.0.0
# 或者在 vite.config.ts 添加类型声明
declare module '@antv/g2';
```

#### 问题 3: 构建产物过大

**解决**: 检查 external 配置，确保不打包第三方库

```typescript
// vite.config.ts
build: {
  rollupOptions: {
    external: [...], // 确保所有依赖都在这里
    output: {
      manualChunks: undefined // UMD 模式不拆包
    }
  }
}
```

### 4. 下一步

完成上述步骤后，您将拥有:

✅ **现代化的构建系统** (Vite)  
✅ **完整的类型支持** (TypeScript 5)  
✅ **测试基础设施** (Vitest)  
✅ **文档生成能力** (TypeDoc)

接下来可以开始:
1. 升级到 React 18
2. 升级到 G2 5.x
3. 逐步迁移到 Hooks

### 5. 快速参考

#### 常用命令速查

```bash
# 开发
npm run dev              # 启动 Vite 开发服务器
npm run storybook        # 启动 Storybook

# 构建
npm run build            # 完整构建
npm run build:themes     # 仅编译主题
npm run build:types      # 仅生成类型

# 测试
npm test                 # 运行测试
npm run test:ui          # UI 界面查看测试
npm run test:coverage    # 测试覆盖率

# 文档
npm run docs             # 生成 API 文档
```

#### 文件映射表

| 旧文件 | 新文件 | 说明 |
|--------|--------|------|
| `build.json` | `vite.config.ts` | 构建配置 |
| `build.before.js` | `scripts/build-themes.ts` | 主题编译 |
| `build.after.js` | `vite.config.ts` (部分) | 构建后处理 |
| `tsconfig.json` | `tsconfig.json` (更新) | TypeScript 配置 |

#### 关键代码片段

**React 18 入口更新**:
```typescript
// src/index.ts 或 main.tsx
import { createRoot } from 'react-dom/client';

const container = document.getElementById('root');
const root = createRoot(container);
root.render(<App />);
```

**G2 5.x 基础使用**:
```typescript
import { Chart } from '@antv/g2';

const chart = new Chart({
  container: 'container',
  autoFit: true,
});

chart
  .interval()
  .data(data)
  .encode('x', 'x')
  .encode('y', 'y')
  .encode('color', 'type');

chart.render();
```

### 6. 获取帮助

如果遇到问题:

1. **查看日志**: `npm run build -- --debug`
2. **检查类型**: `npx tsc --noEmit`
3. **查看依赖**: `npm ls @antv/g2`
4. **清理缓存**: `rm -rf node_modules/.vite`

---

**文档版本**: 1.0  
**最后更新**: 2026-01-09

